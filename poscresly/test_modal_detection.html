<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modal Detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Test de Detección de Modal</h1>
        
        <!-- Botón para abrir modal -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#testModal">
            Abrir Modal de Prueba
        </button>
        
        <!-- Botón para simular WebSocket -->
        <button type="button" class="btn btn-success" onclick="simularWebSocket()">
            Simular Nuevo Pedido (WebSocket)
        </button>
        
        <!-- Modal de prueba -->
        <div class="modal fade" id="testModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Modal de Prueba</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Este es un modal de prueba para verificar la detección.</p>
                        <p>Mientras este modal esté abierto, no debería recargarse la página.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Área de logs -->
        <div class="mt-4">
            <h3>Logs:</h3>
            <div id="logs" class="bg-light p-3" style="height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Función para agregar logs
        function agregarLog(mensaje) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.innerHTML += `<div>[${timestamp}] ${mensaje}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        // Función para simular WebSocket
        function simularWebSocket() {
            agregarLog('Simulando mensaje WebSocket...');
            
            // Verificar si hay modal abierto
            const modalAbierto = document.querySelector('.modal.show') || 
                                document.querySelector('#testModal.show') ||
                                document.querySelector('.modal[style*="display: block"]');
            
            if (modalAbierto) {
                agregarLog('✅ Modal abierto detectado - NO recargando página');
                agregarLog('Modal detectado: ' + (modalAbierto.id || modalAbierto.className));
                agregarLog('Mostrando notificación...');
                
                // Mostrar notificación
                const notification = document.createElement('div');
                notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                notification.innerHTML = `
                    <strong>Nuevo pedido creado</strong><br>
                    Hay nuevos pedidos disponibles. La página se actualizará cuando cierres el modal.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(notification);
                
                // Auto-remover después de 5 segundos
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
                
            } else {
                agregarLog('❌ No hay modal abierto - recargando página');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        }
        
        // Detectar cuando se cierra el modal
        document.getElementById('testModal').addEventListener('hidden.bs.modal', function() {
            agregarLog('Modal cerrado - verificando actualizaciones pendientes');
            
            const notificacionesPendientes = document.querySelectorAll('.alert-info');
            if (notificacionesPendientes.length > 0) {
                agregarLog('Recargando página después de cerrar modal...');
                setTimeout(() => {
                    location.reload();
                }, 500);
            }
        });
        
        // Log inicial
        agregarLog('Sistema de detección de modal iniciado');
    </script>
</body>
</html>


