{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'CSS/menu.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid contenedor-principal mt-5 pt-5">
  <div class="row">
    <div class="col-12">
      <!-- Header con t√≠tulo -->
      <div class="d-flex justify-content-between align-items-center px-5 mb-4">
        <h4 class="mb-0 fw-bold text-dark">
          <i class="fas fa-utensils me-2"></i>Men√∫ del D√≠a
        </h4>
        <div class="d-flex gap-3">
          <button class="btn btn-configurar-menu btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#menuDiaModal">
            <i class="fas fa-cogs me-2"></i>Configurar Men√∫
          </button>
          <button class="btn btn-outline-secondary" onclick="window.history.back()">
            <i class="fas fa-arrow-left me-2"></i>Volver
          </button>
        </div>
      </div>

      <!-- Cards del men√∫ -->
      <div class="row g-4 px-5">
        <!-- Card Sopas -->
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card card-sopas">
            <div class="card-header card-header-sopas">  
              <i class="fas fa-mug-hot me-2"></i>Sopas
            </div>
            <ul class="list-group list-group-flush">
              {% for item in sopas_dia %}
                <li class="list-group-item" data-sopa-id="{{ item.id }}">
                <span class="nombre-sopa">{{ item.sopa }}</span> 
                <span class="cantidad-sopa">
                  <span class="punto-cantidad{% if item.cantidad_actual == 0 %} sin-productos{% elif item.cantidad_actual <= item.cantidad|add:'-1'|multiply:0.5 %} pocos-productos{% endif %}"></span>
                  {{ item.cantidad_actual }}
                </span>
                </li>{% empty %}
                <li class="list-group-item text-muted">No configurado</li>
              {% endfor %}
            </ul>
          </div>
        </div>

        <!-- Card Segundos -->
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card card-segundos">
            <div class="card-header card-header-segundos">
                <i class="fas fa-drumstick-bite me-2"></i>Segundos
            </div>
            <ul class="list-group list-group-flush">
            {% for item in segundos_dia %}
            <li class="list-group-item" data-segundo-id="{{ item.id }}">
            <span class="nombre-segundo">{{ item.segundo }}</span> 
            <span class="cantidad-segundo">
              <span class="punto-cantidad{% if item.cantidad_actual == 0 %} sin-productos{% elif item.cantidad_actual <= item.cantidad|add:'-1'|multiply:0.5 %} pocos-productos{% endif %}"></span>
              {{ item.cantidad_actual }}
            </span>
            </li>{% empty %}
            <li class="list-group-item text-muted">No configurado</li>{% endfor %}</ul></div>
        </div>

        <!-- Card Jugos -->
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card card-jugos">
            <div class="card-header card-header-jugos">
                <i class="fas fa-glass-whiskey me-2"></i>Jugos
            </div>
            <ul class="list-group list-group-flush">
            {% for item in jugos_dia %}
            <li class="list-group-item">{{ item.jugo }}</li>{% empty %}
            <li class="list-group-item text-muted">No configurado</li>{% endfor %}</ul></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Funci√≥n para actualizar cantidades disponibles en tiempo real
async function actualizarCantidadesDisponibles() {
  try {
    console.log('=== ACTUALIZANDO CANTIDADES DISPONIBLES ===');
    
    const response = await fetch('/obtener-cantidades-actualizadas/');
    const data = await response.json();
    
    if (data.status === 'ok') {
      console.log('Cantidades actualizadas recibidas:', data);
      
      // Actualizar sopas
      data.sopas.forEach(sopa => {
        console.log(`Procesando sopa ID ${sopa.id}: ${sopa.nombre}`);
        const sopaElement = document.querySelector(`[data-sopa-id="${sopa.id}"]`);
        if (sopaElement) {
          console.log(`‚úÖ Elemento sopa encontrado para ID ${sopa.id}`);
          const cantidadSpan = sopaElement.querySelector('.cantidad-sopa');
          const puntoSpan = sopaElement.querySelector('.punto-cantidad');
          
          if (cantidadSpan) {
            // Actualizar solo el texto del n√∫mero, manteniendo el punto
            const puntoSpan = cantidadSpan.querySelector('.punto-cantidad');
            if (puntoSpan) {
              // Limpiar el contenido y agregar el punto actualizado + el n√∫mero
              cantidadSpan.innerHTML = '';
              cantidadSpan.appendChild(puntoSpan);
              cantidadSpan.appendChild(document.createTextNode(' ' + sopa.cantidad_actual));
            } else {
              cantidadSpan.textContent = sopa.cantidad_actual;
            }
          }
          
          if (puntoSpan) {
            console.log(`Actualizando punto para sopa ${sopa.nombre}: cantidad_actual=${sopa.cantidad_actual}, cantidad_configurada=${sopa.cantidad_configurada}`);
            // Actualizar color del punto
            puntoSpan.classList.remove('sin-productos', 'pocos-productos');
            if (sopa.cantidad_actual === 0) {
              puntoSpan.classList.add('sin-productos');
              console.log(`  ‚Üí Agregada clase 'sin-productos' (rojo)`);
            } else if (sopa.cantidad_actual <= sopa.cantidad_configurada * 0.5) {
              puntoSpan.classList.add('pocos-productos');
              console.log(`  ‚Üí Agregada clase 'pocos-productos' (naranja)`);
            } else {
              console.log(`  ‚Üí Sin clases especiales (verde)`);
            }
          } else {
            console.log(`No se encontr√≥ punto para sopa ${sopa.nombre}`);
          }
        }
      });
      
      // Actualizar segundos
      data.segundos.forEach(segundo => {
        console.log(`Procesando segundo ID ${segundo.id}: ${segundo.nombre}`);
        const segundoElement = document.querySelector(`[data-segundo-id="${segundo.id}"]`);
        if (segundoElement) {
          console.log(`‚úÖ Elemento segundo encontrado para ID ${segundo.id}`);
          const cantidadSpan = segundoElement.querySelector('.cantidad-segundo');
          const puntoSpan = segundoElement.querySelector('.punto-cantidad');
          
          if (cantidadSpan) {
            // Actualizar solo el texto del n√∫mero, manteniendo el punto
            const puntoSpan = cantidadSpan.querySelector('.punto-cantidad');
            if (puntoSpan) {
              // Limpiar el contenido y agregar el punto actualizado + el n√∫mero
              cantidadSpan.innerHTML = '';
              cantidadSpan.appendChild(puntoSpan);
              cantidadSpan.appendChild(document.createTextNode(' ' + segundo.cantidad_actual));
            } else {
              cantidadSpan.textContent = segundo.cantidad_actual;
            }
          }
          
          if (puntoSpan) {
            console.log(`Actualizando punto para segundo ${segundo.nombre}: cantidad_actual=${segundo.cantidad_actual}, cantidad_configurada=${segundo.cantidad_configurada}`);
            // Actualizar color del punto
            puntoSpan.classList.remove('sin-productos', 'pocos-productos');
            if (segundo.cantidad_actual === 0) {
              puntoSpan.classList.add('sin-productos');
              console.log(`  ‚Üí Agregada clase 'sin-productos' (rojo)`);
            } else if (segundo.cantidad_actual <= segundo.cantidad_configurada * 0.5) {
              puntoSpan.classList.add('pocos-productos');
              console.log(`  ‚Üí Agregada clase 'pocos-productos' (naranja)`);
            } else {
              console.log(`  ‚Üí Sin clases especiales (verde)`);
            }
          } else {
            console.log(`No se encontr√≥ punto para segundo ${segundo.nombre}`);
          }
        }
      });
      
      console.log('Cantidades actualizadas exitosamente');
    } else {
      console.error('Error al obtener cantidades actualizadas:', data.message);
    }
  } catch (error) {
    console.error('Error al actualizar cantidades:', error);
  }
}

// Funci√≥n para mostrar tercer segundo
function mostrarTercerSegundo() {
  const formTercerSegundo = document.getElementById('form-tercer-segundo');
  if (formTercerSegundo) {
    formTercerSegundo.classList.remove('d-none');
  }

  const boton = event.target;
  if (boton) {
    boton.classList.add('d-none');
  }
}

// Actualizar cantidades al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
  actualizarCantidadesDisponibles();
  
  // Actualizar cada 30 segundos
  setInterval(actualizarCantidadesDisponibles, 30000);
  
  // --- Inicializar Select2 solo al abrir el modal de Configurar Men√∫ ---
  const menuDiaModal = document.getElementById('menuDiaModal');
  if (menuDiaModal) {
    menuDiaModal.addEventListener('shown.bs.modal', function () {
      if (typeof $ !== 'undefined' && $.fn.select2) {
        setTimeout(function () {
          $('#menuDiaModal .form-select').each(function () {
            if (!$(this).hasClass("select2-hidden-accessible")) {
              $(this).select2({
                dropdownParent: $('#menuDiaModal .modal-content'),  // üëà Esto es clave
                width: '100%'
              });
            }
          });
          
          // Verificar si hay datos en el tercer segundo y mostrarlo autom√°ticamente
          const tercerSegundoForm = document.getElementById('form-tercer-segundo');
          const tercerSegundoSelect = document.querySelector('#form-tercer-segundo select[name*="segundo"]');
          const botonAgregarTercerSegundo = document.querySelector('button[onclick="mostrarTercerSegundo()"]');
          
          if (tercerSegundoForm && tercerSegundoSelect && botonAgregarTercerSegundo) {
            // Si el tercer segundo tiene un valor seleccionado, mostrarlo
            if (tercerSegundoSelect.value && tercerSegundoSelect.value !== '') {
              tercerSegundoForm.classList.remove('d-none');
              botonAgregarTercerSegundo.classList.add('d-none');
            }
          }
        }, 100);
      }
    });
    
    // Actualizar cantidades cuando se cierre el modal de configuraci√≥n del men√∫
    menuDiaModal.addEventListener('hidden.bs.modal', async function () {
      console.log('=== MODAL DE CONFIGURACI√ìN CERRADO - ACTUALIZANDO CANTIDADES ===');
      // Actualizar cantidades en la p√°gina del men√∫
      await actualizarCantidadesDisponibles();
    });
  }
});
</script>

{% include 'components/modal_menu_config.html' %}

{% endblock %}
