{% extends 'base.html' %}
{% load static %}
{% load math_filters %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'CSS/caja.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid contenedor-principal mt-5 pt-5">
  <div class="row">
    <!-- Sidebar izquierdo -->

    <!-- Contenido principal -->
    <div class="col-12 col-der">

      <!-- Header -->
      <div class="row-btns d-flex justify-content-between align-items-center px-5 mb-4">
        <h4 class="mb-0 fw-bold text-dark">
          <i class="fas fa-tachometer-alt me-2"></i>Dashboard de Caja
        </h4>
        <div class="d-flex align-items-center gap-3">
          <span class="badge bg-dark text-white px-3 py-2" style="font-size: 0.9rem;">
            <i class="fas fa-calendar me-2"></i>{% now "d/m/Y" %}
          </span>
        </div>
      </div>

      <!-- Cards de métricas principales -->
      <div class="row-principal row g-2 px-2 mb-2">


<!-- Card Caja Apertura -->
        <div class="col-6 col-md-6 col-lg-3">
      <div class="card-estado-caja card mb-3">
        <div class="card-body py-3 px-4 w-100">
          <!-- Título con círculo verde 
          <div class="d-flex align-items-center mb-3">
            <div class="bg-success rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 12px; height: 12px;">
              <div class="bg-white rounded-circle" style="width: 6px; height: 6px;"></div>
            </div>
            <h5 class="mb-0 fw-bold">Estado de Caja</h5>
          </div>-->
          
          {% if caja_hoy and caja_hoy.estado == 'abierta' %}
            <!-- Estado actual -->
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong><span class="circulo-indicador"></span>Caja Abierta</strong>
                <small class="text-muted">{{ caja_hoy.fecha|date:"d/m/Y" }} - {{ caja_hoy.fecha_apertura|time:"H:i" }}</small>
            </div>
            
            <!-- Información de caja apertura -->
            <div class="barra-caja-apertura mb-2">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <i class="bi bi-cash-stack me-2 text-white"></i>
                  <span class="text-white">Apertura</span>
                </div>
                <span class="text-white fw-bold">${{ monto_inicial_efectivo|floatformat:2|default:"0.00" }}</span>
              </div>
            </div>
            
            <!-- Botón para cerrar caja -->
            <div class="d-grid gap-2">
              <button class="btn-cerrar-abrir btn btn-lg" onclick="cerrarCaja()">
                <i class="fas fa-times me-2"></i>Cerrar Caja
              </button>
            </div>
          {% elif caja_hoy and caja_hoy.estado == 'cerrada' %}
            <!-- Estado cerrado -->
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong><span class="circulo-indicador"></span>Caja Cerrada</strong>
                <small class="text-muted">{{ caja_hoy.fecha|date:"d/m/Y" }}</small>
            </div>
            
            <div class="text-center text-muted mb-2">
              <small>Caja cerrada para hoy</small>
            </div>
            
            <!-- Botón para abrir caja -->
            <div class="d-grid gap-2">
              <button class="btn-cerrar-abrir btn btn-lg" onclick="abrirCaja()">
                <i class="fas fa-unlock me-2"></i>Abrir Caja
              </button>
            </div>
          {% else %}
            <!-- No hay caja para hoy -->
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong><span class="circulo-indicador"></span>Sin Caja</strong>
                <small class="text-muted">{% now "d/m/Y" %}</small>
            </div>
            
            <div class="text-center text-muted mb-2">
              <small>No hay caja para hoy</small>
            </div>
            
            <!-- Botón para abrir caja -->
            <div class="d-grid gap-2">
              <button class="btn-cerrar-abrir btn btn-lg" onclick="abrirCaja()">
                <i class="fas fa-unlock me-2"></i>Abrir Caja
              </button>
            </div>
          {% endif %}




        </div>

      </div>
          </div>


        <!-- Card Ventas Hoy -->
        <div class="col-6 col-md-6 col-lg-3">
          <div class="metric-card metric-card-transferencia">
            <div class="metric-content">
              <div class="metric-label">Ventas Hoy</div>
              <div class="metric-value">${{ total_ventas|floatformat:2 }}</div>
            </div>
            <div class="metric-icon metric-icon-transferencia">
              <i class="fas fa-chart-line"></i>
            </div>
          </div>
        </div>

        <!-- Card Total Pedidos -->
        <div class="col-6 col-md-6 col-lg-3">
          <div class="metric-card metric-card-pedidos">
            <div class="metric-content">
              <div class="metric-label">Total Pedidos</div>
              <div class="metric-value">{{ pedidos_hoy.count }}</div>
            </div>
            <div class="metric-icon metric-icon-pedidos">
              <i class="fas fa-shopping-cart"></i>
            </div>
          </div>
        </div>

        <!-- Card Total Gastos -->
        <div class="col-6 col-md-6 col-lg-3">
          <div class="metric-card metric-card-promedio">
            <div class="metric-content">
              <div class="metric-label">Total Gastos</div>
              <div class="metric-value">
                {% if pedidos_hoy.count > 0 %}
                  ${% widthratio total_ventas pedidos_hoy.count 1 %}
                {% else %}
                  $0.00
                {% endif %}
              </div>
            </div>
            <div class="metric-icon metric-icon-promedio">
              <i class="fas fa-users"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Cards de información -->
      
      <!-- Resumen de ventas -->
      

      <div class="row g-2 px-2">
        <!-- Widget de evolución de ventas -->
        <div class="col-12 col-lg-4">
          <div class="evolution-chart-widget">
            <div class="evolution-chart-header">
              <div class="evolution-chart-title">
                <i class="fas fa-chart-line me-2"></i>Evolución de Ventas
              </div>
              <div class="evolution-chart-legend">
                <div class="legend-item">
                  <div class="legend-dot legend-dot-ventas"></div>
                  <span>Ventas</span>
                </div>
                <div class="legend-item">
                  <div class="legend-dot legend-dot-pedidos"></div>
                  <span>Pedidos</span>
                </div>
              </div>
            </div>
            
            <div class="evolution-chart-container">
              <canvas id="evolutionChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Widget combinado: Métodos de Pago y Ventas del Día -->
        <div class="col-12 col-lg-4">
          <div class="combined-widget">
            <div class="combined-widget-header">
              <div class="combined-widget-icon">
                <i class="fas fa-cash-register"></i>
              </div>
              <h5 class="combined-widget-title">Ventas del Día</h5>
            </div>
            
            <div class="row g-2">
              <!-- Gráfico de métodos de pago -->
              <div class="col-6">
                <div class="pie-chart-container">
                  <div class="pie-chart" style="background: conic-gradient(
                    #1abc9c 0deg {% widthratio pedidos_efectivo pedidos_efectivo|add:pedidos_transferencia 360 %}deg,
                    #3498db {% widthratio pedidos_efectivo pedidos_efectivo|add:pedidos_transferencia 360 %}deg 360deg
                  );"></div>
                </div>
                
                <div class="payment-legend pt-4">
                  <div class="legend-item">
                    <div style="display: flex; align-items: center;">
                      <div class="legend-color legend-color-efectivo"></div>
                      <span class="legend-label">Efectivo</span>
                    </div>
                    <span class="legend-value">{{ pedidos_efectivo }}</span>
                  </div>
                  <div class="legend-item">
                    <div style="display: flex; align-items: center;">
                      <div class="legend-color legend-color-transferencia"></div>
                      <span class="legend-label">Transferencia</span>
                    </div>
                    <span class="legend-value">{{ pedidos_transferencia }}</span>
                  </div>
                </div>
              </div>
              
              <!-- Resumen de ventas -->
              <div class="col-6">
                <div class="sales-summary">
                  <div class="sales-item">
                    <div class="sales-icon efectivo">
                      <i class="bi bi-cash-stack"></i>
                    </div>
                    <div class="sales-info">
                      <div class="sales-amount">${{ total_efectivo|floatformat:2 }}</div>
                      <div class="sales-label">Efectivo</div>
                    </div>
                  </div>
                  
                  <div class="sales-item">
                    <div class="sales-icon transferencia">
                      <i class="bi bi-arrow-left-right"></i>
                    </div>
                    <div class="sales-info">
                      <div class="sales-amount">${{ total_transferencia|floatformat:2 }}</div>
                      <div class="sales-label">Transferencia</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
      <!-- Análisis de productos vendidos -->
        <div class="col-12 col-lg-4">
          <div class="productos-widget">
            <div class="productos-header">
              <h5 class="productos-title">Productos Vendidos del Día</h5>
              {% if productos_vendidos %}
                <span class="productos-total">Total: {{ productos_vendidos|length }} items</span>
              {% endif %}
            </div>
            
            <div class="productos-body">
              {% if productos_vendidos %}
                {% for producto, datos in productos_vendidos %}
                  <div class="producto-item">
                    <div class="producto-avatar producto-avatar-{{ forloop.counter0|add:1 }}">
                      {{ producto|first|upper }}
                    </div>
                    <div class="producto-info">
                      <div class="producto-nombre">{{ producto }}</div>
                    </div>
                    <div class="producto-cantidad">
                      <span class="cantidad-badge">{{ datos.cantidad }}</span>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="text-center text-muted py-4">
                  <i class="fas fa-utensils fa-3x mb-3"></i>
                  <p>No hay productos vendidos registrados hoy</p>
                  {% if not menu_hoy %}
                    <small class="text-warning">
                      <i class="fas fa-exclamation-triangle me-1"></i>
                      No se ha configurado el menú del día
                    </small>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      

      <!-- Card de gastos -->
      <div class="card mt-3">
        <div class="card-header bg-warning text-dark">
          <i class="fas fa-receipt me-2"></i>Gastos del Día
        </div>
        <div class="card-body">
          {% if gastos_hoy %}
            <div class="text-center mb-3">
              <h4 class="text-danger">${{ total_gastos|floatformat:2 }}</h4>
              <p class="text-muted">{{ gastos_hoy.count }} gastos registrados</p>
            </div>
            <div class="list-group list-group-flush">
              {% for gasto in gastos_hoy|slice:":3" %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="mb-1">{{ gasto.descripcion }}</h6>
                    <small class="text-muted">{{ gasto.categoria|title }}</small>
                  </div>
                  <span class="badge bg-danger">${{ gasto.monto|floatformat:2 }}</span>
                </div>
              {% endfor %}
              {% if gastos_hoy.count > 3 %}
                <div class="list-group-item text-center">
                  <small class="text-muted">... y {{ gastos_hoy.count|add:"-3" }} más</small>
                </div>
              {% endif %}
            </div>
          {% else %}
            <div class="text-center text-muted">
              <i class="fas fa-receipt fa-3x mb-3"></i>
              <p>No hay gastos registrados hoy</p>
            </div>
          {% endif %}
        </div>
      </div>
      <!-- Lista de pedidos recientes (SOLO COMPLETADOS) -->
        <div class="col-12 col-lg-6">
          <div class="pedidos-widget">
            <div class="pedidos-header">
              <h5 class="pedidos-title">Pedidos Completados</h5>
              {% if pedidos_hoy %}
                <span class="pedidos-total">{{ pedidos_hoy|length }} completados</span>
              {% endif %}
            </div>
            
            <div class="pedidos-body">
              {% if pedidos_hoy %}
                {% for pedido in pedidos_hoy %}
                  <div class="pedido-item">
                    <div class="pedido-avatar">
                      <i class="fas fa-receipt"></i>
                    </div>
                    <div class="pedido-info">
                      <div class="pedido-numero">Pedido #{{ pedido.numero_pedido_completo }}</div>
                      <div class="pedido-details">
                        <span class="pedido-hora">{{ pedido.fecha_creacion|time:"H:i" }}</span>
                        <span class="pedido-separator">•</span>
                        <span class="pedido-cliente">{{ pedido.contacto|default:"Cliente" }}</span>
                      </div>
                    </div>
                    <div class="pedido-meta">
                      <div class="pedido-tipo">
                        <span class="tipo-badge tipo-{{ pedido.tipo|lower }}">
                          {{ pedido.tipo }}
                        </span>
                      </div>
                      <div class="pedido-pago">
                        {% if pedido.forma_pago == 'Efectivo' %}
                          <i class="bi bi-cash-stack text-success"></i>
                        {% else %}
                          <i class="bi bi-arrow-left-right text-primary"></i>
                        {% endif %}
                      </div>
                      <div class="pedido-total">${{ pedido.total|floatformat:2 }}</div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="text-center text-muted py-4">
                  <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                  <p>No hay pedidos registrados hoy</p>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
    </div>
  </div>
</div>

<!-- Modal para abrir caja -->
<div class="modal fade" id="modalAbrirCaja" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-unlock me-2"></i>Abrir Caja
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="formAbrirCaja">
        <div class="modal-body">
          <div class="mb-3">
            <label for="monto_inicial_efectivo" class="form-label">Monto Inicial Efectivo</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control" id="monto_inicial_efectivo" name="monto_inicial_efectivo" step="0.01" min="0" value="0.00" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="monto_inicial_transferencia" class="form-label">Monto Inicial Transferencia</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control" id="monto_inicial_transferencia" name="monto_inicial_transferencia" step="0.01" min="0" value="0.00">
            </div>
          </div>
          <div class="mb-3">
            <label for="observaciones" class="form-label">Observaciones</label>
            <textarea class="form-control" id="observaciones" name="observaciones" rows="3" placeholder="Observaciones adicionales..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">
            <i class="fas fa-unlock me-2"></i>Abrir Caja
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para cerrar caja -->
<div class="modal fade" id="modalCerrarCaja" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-lock me-2"></i>Cerrar Caja
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="formCerrarCaja">
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Resumen del día:</strong><br>
            Ventas en efectivo: ${{ total_efectivo|floatformat:2 }}<br>
            Ventas por transferencia: ${{ total_transferencia|floatformat:2 }}<br>
            Total de ventas: ${{ total_ventas|floatformat:2 }}
          </div>
          <div class="mb-3">
            <label for="monto_final_efectivo" class="form-label">Monto Final Efectivo</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control" id="monto_final_efectivo" name="monto_final_efectivo" step="0.01" min="0" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="monto_final_transferencia" class="form-label">Monto Final Transferencia</label>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control" id="monto_final_transferencia" name="monto_final_transferencia" step="0.01" min="0">
            </div>
          </div>
          <div class="mb-3">
            <label for="observaciones_cierre" class="form-label">Observaciones de Cierre</label>
            <textarea class="form-control" id="observaciones_cierre" name="observaciones_cierre" rows="3" placeholder="Observaciones del cierre..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-lock me-2"></i>Cerrar Caja
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Función para abrir caja
function abrirCaja() {
  const modal = new bootstrap.Modal(document.getElementById('modalAbrirCaja'));
  modal.show();
}

// Función para cerrar caja
function cerrarCaja() {
  const modal = new bootstrap.Modal(document.getElementById('modalCerrarCaja'));
  modal.show();
}

// Manejar envío del formulario de abrir caja
document.getElementById('formAbrirCaja').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  
  try {
    const response = await fetch('{% url "abrir_caja" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('Caja abierta exitosamente');
      location.reload(); // Recargar la página para mostrar el nuevo estado
    } else {
      alert('Error: ' + data.message);
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error inesperado al abrir la caja');
  }
});

// Manejar envío del formulario de cerrar caja
document.getElementById('formCerrarCaja').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  
  try {
    const response = await fetch('{% url "cerrar_caja" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('Caja cerrada exitosamente');
      location.reload(); // Recargar la página para mostrar el nuevo estado
    } else {
      alert('Error: ' + data.message);
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error inesperado al cerrar la caja');
  }
});

// Configurar gráfico de evolución de ventas
document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('evolutionChart');
  if (ctx) {
    const datosSemana = [
      {% for dato in datos_semana %}
        {
          dia: '{{ dato.dia }}',
          ventas: {{ dato.ventas }},
          pedidos: {{ dato.pedidos }}
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: datosSemana.map(d => d.dia),
        datasets: [{
          label: 'Ventas',
          data: datosSemana.map(d => d.ventas),
          borderColor: '#3498db',
          backgroundColor: 'rgba(52, 152, 219, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4,
          pointBackgroundColor: '#3498db',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 6,
          pointHoverRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false // Ocultamos la leyenda porque la tenemos en el header
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: '#3498db',
            borderWidth: 1,
            callbacks: {
              title: function(context) {
                return context[0].label;
              },
              label: function(context) {
                const index = context.dataIndex;
                const dato = datosSemana[index];
                return [
                  `Ventas: $${dato.ventas.toFixed(2)}`,
                  `Pedidos: ${dato.pedidos}`
                ];
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.1)',
              drawBorder: false
            },
            ticks: {
              color: '#6c757d',
              font: {
                size: 12
              },
              callback: function(value) {
                return '$' + value;
              }
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              color: '#6c757d',
              font: {
                size: 12
              }
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    });
  }
});
</script>

{% endblock %}
